// Sample program for the QX-mini51 STC89C52 development board
//
// 12864 LCD display test
// 12864 plugs into L1 connector
// J6 must be open to use LCD
//
#include <8051.h>

#include <typedefs.h>

#include <periphs.h>

__code uchar pic2[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x78, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x1E, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x07, 0x80, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xC0, 0x01, 0xE0, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x78, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x1E, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x07, 0x80,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xC0, 0x00, 0x00, 0x01, 0xC0,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x70,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x1C,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x1E,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x03, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x7E,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x01, 0xE6,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x07, 0x82,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x02,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x01, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x78, 0x03,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x01, 0xE0, 0x00, 0x00, 0x00, 0x01, 0xE0, 0x03,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x01, 0x78, 0x00, 0x00, 0x00, 0x07, 0x80, 0x01,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x03, 0x1E, 0x00, 0x00, 0x00, 0x1E, 0x00, 0x07,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x03, 0x07, 0x80, 0x00, 0x00, 0x78, 0x00, 0x1F,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x02, 0x01, 0xE0, 0x00, 0x01, 0xE0, 0x00, 0x3F,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x06, 0x00, 0x78, 0x1F, 0x07, 0x80, 0x01, 0xF1,
	    0x80, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0E, 0x00, 0x1E, 0x3F, 0x9E, 0x00, 0x03, 0xF9,
	    0x80, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0E, 0x00, 0x07, 0xB3, 0x78, 0x00, 0x0F, 0xF9,
	    0x80, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0F, 0x80, 0x01, 0xFF, 0xE0, 0x00, 0x79, 0x98,
	    0x80, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x7F, 0x80, 0x00, 0xE0, 0xD8,
	    0x80, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0F, 0xF8, 0x00, 0x0C, 0x00, 0x07, 0xE0, 0xF8,
	    0x80, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0E, 0x7E, 0x00, 0x0C, 0x00, 0x1F, 0xF0, 0xF8,
	    0x80, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0E, 0x1F, 0x80, 0x0C, 0x00, 0x7E, 0x70, 0xDC,
	    0x80, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0F, 0x07, 0xE0, 0x0C, 0x01, 0xE3, 0x70, 0x5C,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0F, 0x81, 0xF8, 0x0C, 0x07, 0x83, 0x70, 0x5F,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0D, 0xE0, 0x7E, 0x0C, 0x1F, 0xC1, 0xF0, 0x5F,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0F, 0x78, 0x3F, 0x8C, 0x7F, 0xC1, 0xB8, 0x47,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0F, 0x1E, 0x0F, 0xED, 0xEC, 0xE1, 0xB8, 0xC7,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1F, 0x07, 0x83, 0xFF, 0xC6, 0xE1, 0xB9, 0xC7,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1F, 0x07, 0xE0, 0xFF, 0xE7, 0xE1, 0xBF, 0x07,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1F, 0x07, 0xF8, 0x3F, 0xE7, 0xE1, 0xBF, 0x07,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1F, 0x07, 0x9E, 0x0C, 0xE6, 0xE1, 0x8F, 0x07,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1F, 0x07, 0x87, 0x8C, 0xE6, 0xE3, 0x8F, 0x83,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1F, 0x0F, 0x81, 0xED, 0xE6, 0xE7, 0x0F, 0x83,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1F, 0x07, 0x00, 0x7F, 0xE6, 0xFE, 0x0F, 0x83,
	    0x40, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1E, 0x76, 0xFE, 0x0F, 0x83,
	    0x40, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1E, 0x00, 0x00, 0x00, 0x72, 0x1E, 0x0F, 0x83,
	    0x40, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1E, 0x00, 0x00, 0x00, 0x7E, 0x1A, 0x0F, 0x83,
	    0x40, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x1E, 0x00, 0x00, 0x00, 0x7C, 0x1A, 0x0F, 0x83,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0C, 0x00, 0x00, 0x00, 0x78, 0x1A, 0x0F, 0x83,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x1A, 0x07, 0x83,
	    0xC0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x1E, 0x07, 0x80,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x1F, 0x07, 0x80,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x1F, 0x07, 0x80,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x1F, 0x07, 0x80,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x1F, 0x07, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x1F, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x1F, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x1F, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x1F, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x0C, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00,
};

// QX product name
__code uchar IC_DAT[] = {
	"   QX-mini51    "
	"    原厂直销    "
	"  单片机开发板  "
	"    QXMCU       "
};

// Chinese poem
__code uchar IC_DAT2[] = {
	"  床前明月光，  "	//0x80
	"  疑是地上霜，  "	//0x90
	"  举头望明月。  "	//0x88
	"  低头思故乡。  "	//0x98
};

// Delay 10 * n ms
void delayms(uint n)
{
	uint i, j;

	for (i = 0; i < n; i++)
		for (j = 0; j < 2000; j++);
}

void delay(uint m)
{
	uint i, j;

	for (i = 0; i < m; i++)
		for (j = 0; j < 10; j++);
}

uchar Convert(unsigned char In_Date)
{
	uchar i, Out_Date = 0, temp = 0;

	for (i = 0; i < 8; i++) {
		// code commented out
		// temp = (In_Date >> i) & 0x01;
		// Out_Date | = (temp << (7-i));
		Out_Date = In_Date;
	}
	return Out_Date;
}

// Transfer command when DI = 0 or data when DI = 1
void TransferData(char data1, uchar DI)
{
	LCD_RW = 0;
	LCD_RS = DI;
	delay(1);
	P2 = Convert(data1);
	LCD_EP = 1;
	delay(1);
	LCD_EP = 0;
}

// LCD font initialisation
void initial(void)
{
	delay(40);
	LCD_PSB = 1;		// 8-bit parallel mode
	delay(1);
	LCD_RES = 0;		// reset
	delay(1);
	LCD_RES = 1;
	delay(10);
	TransferData(0x30, 0);	// extended function, 8 bit, RE = 0 basic set
	delay(100);		// G = 0, graphic display off
	TransferData(0x30, 0);
	delay(37);
	TransferData(0x08, 0);	// display on control
	delay(100);
	TransferData(0x10, 0);	// cursor display
	delay(100);
	TransferData(0x0C, 0);	// display control D = 1 on
	delay(100);
	TransferData(0x01, 0);	// clear display
	delay(10);
	TransferData(0x06, 0);	// entry mode, cursor R to L
	delay(100);
}

// LCD graphics display initialisation
void initial2(void)
{
	delay(40);
	LCD_PSB = 1;		// 8 bit parallel mode
	delay(1);
	LCD_RES = 0;		// reset
	delay(1);
	LCD_RES = 1;
	delay(10);
	TransferData(0x36, 0);	// extended function, RE = 0
	delay(100);
	TransferData(0x36, 0);
	delay(37);
	TransferData(0x3E, 0);	// extended function DL = 8-bit, RE = 1, G = 1
	delay(100);
	TransferData(0x01, 0);	// clear display
	delay(100);
}

void DisplayGraphic(__code uchar * adder)
{
	int i, j;

	// display first half
	for (i = 0; i < 32; i++) {
		TransferData((0x80 + i), 0);	// set vertical address
		TransferData(0x80, 0);	// set horizontal address
		for (j = 0; j < 16; j++) {
			TransferData(*adder, 1);
			adder++;
		}
	}
	// display second half
	for (i = 0; i < 32; i++) {
		TransferData((0x80 + i), 0);	// set vertical address
		TransferData(0x88, 0);	// set horizontal address
		for (j = 0; j < 16; j++) {
			TransferData(*adder, 1);
			adder++;
		}
	}
}

void lcd_mesg(__code uchar * adder1)
{
	uchar i;

	TransferData(0x80, 0);	// set graphic display RAM addr
	delay(100);
	for (i = 0; i < 32; i++) {
		TransferData(*adder1, 1);
		adder1++;
	}
	TransferData(0x90, 0);	// set graphic display RAM addr
	delay(100);
	for (i = 32; i < 64; i++) {
		TransferData(*adder1, 1);
		adder1++;
	}
}

void main(void)
{
	while (1) {
		initial2();

		DisplayGraphic(pic2);
		delayms(200);

		initial();
		delay(100);
		lcd_mesg(IC_DAT);
		delayms(240);
		delayms(240);

		initial();
		delay(100);
		lcd_mesg(IC_DAT2);
		delayms(240);
		delayms(240);
		initial();
	}
}
